<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <style>
        body {
            font-size: 0.8em;
            padding: 0;
            margin: 0;
            color: white;
        }

        .main {
            background: #444;
            width: 359px;
        }

        #title {
            background: #444 url(frmslider_ttl_gj.png) no-repeat left top;
            height: 23px;
            width: 359px;
        }

        #top {
            margin: 2px;
        }

        #slider-container {
            clear: left;
            width: 359px;
            height: 40px;
            position: relative;
        }

        #slider,
        #slider-right,
        #slider-left {
            padding: 0;
            margin: 0;
            top: 0px;
            height: 32px;
            z-index: 0;
            background-repeat: no-repeat;
            background-image: url(slider_bg.gif);
            position: absolute;
        }

        #slider-right {
            left: 0px;
            width: 12px;
            background-position: 0px 0px;
        }

        #slider {
            left: 12px;
            width: 180px;
            background-position: -12px 0px;
        }

        #slider-left {
            left: 180px;
            width: 32px;
            background-position: -180px 0px;
        }

        .ui-slider-handle {
            position: absolute;
            z-index: 1;
            height: 21px;
            width: 11px;
            top: 10px;
            left: -20px;
            background-image: url(slider_f.gif);
        }

        .ui-state-focus {
            outline: none;
        }

        #time {
            float: left;
            width: 100px;
            height: 20px;
            top: 5px;
            text-align: center;
            left: 230px;
            border: 1px solid #fff;
            vertical-align: middle;
            position: absolute;
        }

        #img {
            position: relative;
            width: 352px;
            height: 400px;
            border: 0px;
            z-index: 1
        }

        #gauge-container {
            position: absolute;
            top: 91px;
            left: 303px;
            height: 300px;
            width: 49px;
            background-color: #fff;
        }
    </style>
</head>

<body>
    <div class="main">
        <div id="title"></div>
        <div id="top">
            <input type="checkbox" id="autoupdate" value="1" checked>
            <label for="autoupdate">2秒毎に自動更新 </label>
            <input type="button" value="最新の状態に更新" onclick="dragging = true; updatevalue(0); update(0);"
                style="width:150px;">
            <a href="https://www.kyoshin.bosai.go.jp/kyoshin/docs/kyoshinmonitor.html" target="_blank"
                style="position:absolute; top:25px; left:320px;">
                <img src="Button-Help-icon.png">
            </a>
        </div>
        <div id="img">
            <img src="base_map.png" width="352" height="400" style="margin-left: 3px; position: absolute;">
            <img id="map_1" width="352" height="400" style="margin-left: 3px; z-index: 10; position: absolute;">
            <div id="gauge-container">
                <img id="scaleimg" src="nied_acmap_s_w_scale.gif">
            </div>
        </div>
        <div id="bottom">
            <select id="kind">
                <option value="acmap">最大加速度</option>
                <option value="jma">リアルタイム震度</option>
            </select>
            <input type="radio" name="depth" id="surface" value="s" checked>
            <label for="surface">地表</label>
            <input type="radio" name="depth" id="borehole" value="b">
            <label for="borehole">地中</label>
        </div>
        <div id="slider-container">
            <div id="slider-right"></div>
            <div id="slider-left"></div>
            <div id="slider" class="ui-slider ui-slider-horizontal ui-widget ui-widget-content ui-corner-all"><a
                    class="ui-slider-handle ui-state-default ui-corner-all" href="#" style="left: 100%;"></a></div>
            <div id="time">最新</div>
        </div>
    </div>
    <script>
        const min = -3600;
        const max = 0;
        const step = 20;
        let timeoffset = 0;
        const slider = document.getElementById("slider");
        const handle = slider.querySelector(".ui-slider-handle");
        const sliderWidth = slider.offsetWidth;
        const handleWidth = handle.offsetWidth;
        let value = 0;
        function update(v) {
            const t = document.getElementById("time");
            t.textContent = v === 0 ? "最新" : -(Math.floor(v / 20)) + "分前";
        }
        function valueToPos(v) {
            const ratio = (v - min) / (max - min);
            return ratio * sliderWidth;
        }
        function setHandleByValue(v) {
            const pos = valueToPos(v);
            handle.style.left = (pos - handleWidth / 2) + 4 + "px";
        }
        let dragging = false;
        handle.addEventListener("mousedown", (e) => {
            dragging = true;
            e.preventDefault();
        });
        function updatevalue(e) {
            if (!dragging) return;
            const rect = slider.getBoundingClientRect();
            let x = e.clientX - rect.left;
            x = Math.max(0, Math.min(sliderWidth, x));
            let ratio = x / sliderWidth;
            let newValue = min + ratio * (max - min);
            newValue = Math.round(newValue / step) * step;
            value = newValue;
            setHandleByValue(value);
        }
        document.addEventListener("mousemove", (e) => {
            updatevalue(e);
        });
        document.addEventListener("mouseup", () => {
            if (dragging) {
                dragging = false;
                update(value);
            }
        });
        setHandleByValue(value);
        update(value);
        fetch('https://api.wolfx.jp/ntp.json').then(r => r.json()).then(r => {
            timeoffset = r.timestamp - Date.now();
        })
        function main() {
            if (document.getElementById('autoupdate').checked) {
                const realtime = new Date(new Date() - 1900 + value * 3000 + timeoffset);
                const year = realtime.getFullYear();
                const month = ('00' + (realtime.getMonth() + 1)).slice(-2);
                const date = ('00' + realtime.getDate()).slice(-2);
                const hour = ('00' + realtime.getHours()).slice(-2);
                const minute = ('00' + realtime.getMinutes()).slice(-2);
                const second = ('00' + realtime.getSeconds()).slice(-2);
                const nowdate = year + month + date + hour + minute + second;
                const type = document.getElementById('kind').value;
                const depth = (document.getElementById('surface').checked) ? "s" : "b";
                document.getElementById('map_1').src = `https://smi.lmoniexp.bosai.go.jp/data/map_img/RealTimeImg/${type}_${depth}/${nowdate.substr(0, 8)}/${nowdate}.${type}_${depth}.gif`;
            }
        }
        document.getElementById('kind').addEventListener('change', (e) => {
            document.getElementById('scaleimg').src = `nied_${e.target.value}_s_w_scale.gif`;
        })
        setInterval(main, 2000);
    </script>
</body>

</html>